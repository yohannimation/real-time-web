<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>
<body class="container py-5">
    <section id="auth">
        <h1>Register / Login</h1>
        <div class="container">
            <div class="row">
                <form class="col-6" id="registerForm">
                    <h2 class="mb-4 border-bottom">Register</h2>
                    <div class="mb-3">
                        <label for="registerUsername" class="form-label">Username</label>
                        <input class="form-control" id="registerUsername" placeholder="username" name="username" required />
                    </div>
                    <div class="mb-3">
                        <label for="registerPassword" class="form-label">Password</label>
                        <input class="form-control" id="registerPassword" placeholder="Password" name="Password" type="password" required />
                    </div>
                    <button type="submit" class="btn btn-primary">S'inscrire</button>
                </form>
                
                <form class="col-6" id="loginForm">
                    <h2 class="mb-4 border-bottom">Login</h2>
                    <div class="mb-3">
                        <label for="loginUsername" class="form-label">Username</label>
                        <input class="form-control" id="loginUsername" placeholder="username" name="username" required />
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label">Password</label>
                        <input class="form-control" id="loginPassword" placeholder="Password" name="Password" type="password" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Se connecter</button>
                </form>
            </div>
        </div>
        
        <div class=" mt-4 d-flex justify-content-between align-items-center">
            <small id="meInfo"></small>
            <button id="logoutBtn" class="btn btn-danger">Se déconnecter</button>
        </div>
    </section>
    
    <hr />
    
    <section id="notesSection">
        <h1>Notes</h1>
        <form id="createNoteForm">
          <div class="input-group mb-3">
            <input class="form-control" id="noteContent" placeholder="Nouvelle note..." required />
            <button class="btn btn-outline-secondary" type="submit">Ajouter</button>
          </div>
        </form>
        <ul id="notes" class="list-group"></div>
    </section>
</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>
    const apiBase = '';
let socket = null;

function parseJwt(token) {
  try {
    return JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
  } catch (e) {
    return null;
  }
}

function getToken() {
  return localStorage.getItem('token');
}

function setToken(t) {
  if (t) localStorage.setItem('token', t);
  else localStorage.removeItem('token');
}

// Requête API avec token automatiquement ajouté
async function api(path, opts = {}) {
  opts.headers = opts.headers || {};
  const token = getToken();
  if (token) opts.headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(path, opts);
  if (!res.ok) {
    const txt = await res.json().catch(() => ({ error: 'unknown' }));
    throw txt;
  }
  return res.json();
}

// Affichage des notes
async function fetchNotes() {
  const notes = await fetch('/notes').then(r => r.json());
  renderNotes(notes);
}

function renderNotes(notes) {
  const container = document.getElementById('notes');
  container.innerHTML = '';
  const token = getToken();
  const me = token ? parseJwt(token) : null;

  notes.forEach(n => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between';
    const author = n.authorId
      ? n.authorId === (me && me.userId)
        ? '(moi)'
        : `(auteur: ${n.authorId.slice(0, 6)})`
      : '(anonyme)';

    li.innerHTML = `
      <div>
        <p><strong>${escapeHtml(n.content)}</strong></p>
        <p>${author}</p>
      </div>
    `;

    // Boutons d’édition visibles uniquement pour l’auteur
    if (me && me.userId === n.authorId) {
      const editBtn = document.createElement('button');
      editBtn.className = "btn btn-warning";
      editBtn.textContent = 'Modifier';
      editBtn.onclick = () => {
        const newText = prompt('Modifier la note', n.content);
        if (newText != null)
          api(`/notes/${n.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: newText }),
          }).catch(err => alert(JSON.stringify(err)));
      };

      const delBtn = document.createElement('button');
      delBtn.className = "btn btn-danger";
      delBtn.textContent = 'Supprimer';
      delBtn.onclick = () => {
        if (confirm('Supprimer ?'))
          api(`/notes/${n.id}`, { method: 'DELETE' }).catch(err =>
            alert(JSON.stringify(err))
          );
      };

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'd-flex justify-content-center align-items-center gap-2';

      buttonContainer.appendChild(editBtn);
      buttonContainer.appendChild(delBtn);

      li.appendChild(buttonContainer);
    }

    container.appendChild(li);
  });
}

function escapeHtml(s) {
  return (s + '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

// Connexion Socket.IO
function connectSocket() {
  const token = getToken();
  if (socket) socket.disconnect();
  socket = io({ auth: { token } });

  socket.on('connect', () => console.log('socket connected'));
  socket.on('notes_updated', notes => {
    renderNotes(notes);
  });
}

// Gestion des formulaires
document.getElementById('registerForm').addEventListener('submit', async e => {
  e.preventDefault();
    const username = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;
  try {
    await fetch('/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
    });
    alert('Inscription réussie — connectez-vous maintenant.');
  } catch (err) {
    alert(JSON.stringify(err));
  }
});

document.getElementById('loginForm').addEventListener('submit', async e => {
  e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
  try {
    const res = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
    });
    const data = await res.json();
    setToken(data.token);
    updateUI();
    connectSocket();
  } catch (err) {
    alert('Erreur de connexion');
  }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  setToken(null);
  updateUI();
  connectSocket();
});

document.getElementById('createNoteForm').addEventListener('submit', async e => {
  e.preventDefault();
  const content = document.getElementById('noteContent').value.trim();
  if (!content) return;
  try {
    await api('/notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content }),
    });
    document.getElementById('noteContent').value = '';
  } catch (err) {
    alert(JSON.stringify(err));
  }
});

// Mise à jour de l'affichage utilisateur connecté
async function updateUI() {
    const token = getToken();
    const meDiv = document.getElementById('meInfo');
    if (token) {
        const p = parseJwt(token);
        meDiv.innerHTML = `<span class="badge text-bg-success">Connecté</span> : ${p.username} — id: ${p.userId}`;
    } else {
        meDiv.innerHTML = `<span class="badge text-bg-danger">Non connecté</span>`;
    }
}

// Initialisation
fetchNotes();
updateUI();
connectSocket();

</script>