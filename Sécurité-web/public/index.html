<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteNinja - Your Digital Notebook</title>
    <link rel="icon" type="image/x-icon" href="https://static.photos/technology/200x200/42">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#6366f1',
                        },
                        secondary: {
                            500: '#ec4899',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .note-card {
            transition: all 0.3s ease;
            transform-origin: center;
        }
        .note-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-12 text-center">
            <div class="flex justify-center items-center mb-4">
                <i data-feather="edit" class="text-primary-500 w-12 h-12 mr-3"></i>
                <h1 class="text-4xl font-bold text-gray-800">Note<span class="text-primary-500">Ninja</span></h1>
            </div>
            <p class="text-gray-600 max-w-2xl mx-auto">Your digital scribble pad with superpowers. Capture, organize, and conquer your thoughts!</p>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Add Note Button -->
            <div class="flex justify-end mb-6">
                <button onclick="openNoteModal()" class="flex items-center bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg transition-all shadow-md hover:shadow-lg">
                    <i data-feather="plus" class="mr-2"></i> New Note
                </button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Content</th>
                        <th>Author ID</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="notes-container">
                    <tr>
                        <td>1</td>
                        <td>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Mollitia sed quo distinctio necessitatibus nostrum quasi error facere ipsum sint illo voluptas dignissimos quibusdam laborum eveniet, quod numquam, non architecto praesentium porro magnam rem eum dolores odit? Fugiat beatae exercitationem non omnis corrupti, qui praesentium amet iste quo, commodi, earum asperiores?</td>
                        <td>10</td>
                        <td class="flex items-center flex-col">
                            <button>Modifier</button>
                            <button>Supprimer</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </main>

        <!-- Note Modal -->
        <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 mx-4 fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800" id="modal-title">Add New Note</h3>
                </div>
                <form id="note-form" onsubmit="handleNoteSubmit(event)">
                    <input type="hidden" id="note-id">
                    <div class="mb-4">
                        <label for="note-title" class="block text-gray-700 mb-2">Title</label>
                        <input type="text" id="note-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Note title" required>
                    </div>
                    <div class="mb-6">
                        <label for="note-content" class="block text-gray-700 mb-2">Content</label>
                        <textarea id="note-content" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Write your thoughts here..." required></textarea>
                    </div>
                    <div class="mb-6">
                    <label for="note-content" class="block text-gray-700 mb-2">ID Auteur</label>
                        <input type="text" id="note-author" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Auteur" required>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeNoteModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">Save Note</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // Elements
        const modal = document.getElementById("note-modal");
        const notesContainer = document.getElementById('notes-container');
        const addForm = document.getElementById('note-form');
        let modalTitleInput = document.getElementById("note-title");
        let modalContentInput = document.getElementById("note-content");
        let modalAuthorIdInput = document.getElementById("note-author");

        const openNoteModal = (id = '', content = '', authorId = '') => {
            modalTitleInput.value = id
            modalContentInput.value = content
            modalAuthorIdInput.value = authorId

            modal.classList.remove("hidden");
        }

        const closeNoteModal = () => {
            modal.classList.add("hidden");

            modalTitleInput.value = '' 
            modalContentInput.value = '' 
            modalAuthorIdInput.value = '' 
        }

        // Récupérer et afficher la liste des notes (initial)
        async function fetchNotesAndRender() {
            try {
                const res = await fetch('/notes');
                const notes = await res.json();
                renderNotes(notes);
            } catch (err) {
                console.error('Erreur fetch notes', err);
            }
        }

        // Render
        function renderNotes(notes) {
            notesContainer.innerHTML = '';
            if (!notes || notes.length === 0) {
                notesContainer.innerHTML = '<p>Aucune note.</p>';
                return;
            }

            notes.slice().reverse().forEach(note => {
                const div = document.createElement('div');
                div.className = 'note';
                const left = document.createElement('div');
                left.style.flex = '1';
                const content = document.createElement('div');
                content.className = 'content';
                content.textContent = note.content;

                const meta = document.createElement('div');
                meta.className = 'meta';
                meta.textContent = `id: ${note.id} — auteur: ${note.authorId ?? 'anonymous'} — mis à jour: ${new Date(note.updatedAt).toLocaleString()}`;

                left.appendChild(content);
                left.appendChild(meta);

                const actions = document.createElement('div');

                const editBtn = document.createElement('button');
                editBtn.textContent = 'Modifier';
                editBtn.onclick = () => editNote(note);

                const delBtn = document.createElement('button');
                delBtn.textContent = 'Supprimer';
                delBtn.onclick = () => deleteNote(note.id);

                actions.appendChild(editBtn);
                actions.appendChild(delBtn);

                div.appendChild(left);
                div.appendChild(actions);

                notesContainer.appendChild(div);
            });
        }

        // Add note
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const content = newContentEl.value.trim();
            if (!content) return alert('Écris quelque chose avant d\'ajouter.');

            try {
                const res = await fetch('/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Erreur lors de l\'ajout');
                }
                newContentEl.value = '';
                // On ne rafraîchit pas ici car le serveur va émettre 'notes_updated'
            } catch (err) {
                console.error(err);
                alert('Erreur: ' + err.message);
            }
        });

        // Edit note (simple prompt)
        async function editNote(note) {
            const newContent = prompt('Modifier la note', note.content);
            if (newContent === null) return; // cancel

            const trimmed = newContent.trim();
            if (trimmed === '') return alert('Le contenu ne peut pas être vide.');

            try {
                const res = await fetch('/notes/' + encodeURIComponent(note.id), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: trimmed })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Erreur lors de la modification');
                }
                // Le rafraîchissement sera géré via socket
            } catch (err) {
                console.error(err);
                alert('Erreur: ' + err.message);
            }
        }

        // Delete note
        async function deleteNote(id) {
            if (!confirm('Supprimer cette note ?')) return;

            try {
                const res = await fetch('/notes/' + encodeURIComponent(id), {
                    method: 'DELETE'
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Erreur lors de la suppression');
                }
                // Le rafraîchissement sera géré via socket
            } catch (err) {
                console.error(err);
                alert('Erreur: ' + err.message);
            }
        }

        // Socket: écoute les mises à jour
        socket.on('notes_updated', (notes) => {
            renderNotes(notes);
        });

        // Au chargement initial, on récupère la liste (au cas où la socket ne l'a pas encore fournie)
        fetchNotesAndRender();
    </script>
</body>
</html>
